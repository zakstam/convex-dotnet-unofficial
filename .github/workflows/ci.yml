name: CI/CD

on:
  pull_request:
    branches: [main]
  release:
    types: [published]

permissions:
  contents: write

env:
  DOTNET_VERSION: "9.0.x"
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  build-and-test:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Display .NET info
        run: dotnet --info

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release --verbosity normal

      - name: Pack packages (main branch only)
        if: github.ref == 'refs/heads/main' || github.event_name == 'release'
        run: |
          mkdir -p ./nupkg

          # Pack all packable projects
          for project in $(find ./src -name "*.csproj" -not -path "*/obj/*" -not -path "*/bin/*"); do
            # Skip non-packable projects
            if grep -q "<IsPackable>false</IsPackable>" "$project"; then
              echo "â­ï¸  Skipping non-packable: $project"
              continue
            fi

            echo "ðŸ“¦ Packing: $project"
            if [ "${{ github.event_name }}" = "release" ]; then
              VERSION="${{ github.event.release.tag_name }}"
              VERSION="${VERSION#v}"  # Remove 'v' prefix
              dotnet pack "$project" \
                --no-build \
                --configuration Release \
                --output ./nupkg \
                -p:Version="$VERSION" \
                -p:PackageVersion="$VERSION" \
                -p:ContinuousIntegrationBuild=true
            else
              dotnet pack "$project" \
                --no-build \
                --configuration Release \
                --output ./nupkg
            fi
          done

          # Validate packages were created
          PACKAGE_COUNT=$(find ./nupkg -name "*.nupkg" -not -name "*.snupkg" | wc -l)
          if [ "$PACKAGE_COUNT" -eq 0 ]; then
            echo "âŒ No packages found"
            exit 1
          fi

          echo "âœ… Created $PACKAGE_COUNT package(s)"
          ls -lh ./nupkg/

      - name: Upload packages as artifacts
        if: github.ref == 'refs/heads/main' || github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkg/*.nupkg
          retention-days: 7

  publish-nuget:
    needs: build-and-test
    runs-on: [self-hosted, Linux, X64]
    if: github.event_name == 'release'

    steps:
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkg

      - name: Publish to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          echo "ðŸ“¦ Publishing packages to NuGet.org..."
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key "$NUGET_API_KEY" \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \
            --no-symbols

          echo "ðŸ“¦ Publishing symbol packages to NuGet.org..."
          if ls ./nupkg/*.snupkg 1> /dev/null 2>&1; then
            dotnet nuget push ./nupkg/*.snupkg \
              --api-key "$NUGET_API_KEY" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          else
            echo "â„¹ï¸  No symbol packages found (this is okay)"
          fi

      - name: Update GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          echo "ðŸ“ Updating GitHub release with NuGet info..."

          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix

          # Get current release body
          gh release view "${{ github.event.release.tag_name }}" --json body -q .body > /tmp/current-body.md

          # Append NuGet info
          {
            echo ""
            echo ""
            echo "## ðŸ“¦ NuGet Packages"
            echo ""
            echo "[![NuGet](https://img.shields.io/nuget/v/Convex.Client.svg)](https://www.nuget.org/packages/Convex.Client/)"
            echo ""
            echo "Install via:"
            echo '```bash'
            echo "dotnet add package Convex.Client"
            echo '```'
          } >> /tmp/current-body.md

          # Update release
          gh release edit "${{ github.event.release.tag_name }}" --notes-file /tmp/current-body.md
