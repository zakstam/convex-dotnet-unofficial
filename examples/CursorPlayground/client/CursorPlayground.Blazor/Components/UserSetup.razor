@inject CursorService CursorService

<div class="setup-modal @(IsVisible ? "visible" : "")">
    <div class="setup-content">
        <div class="setup-header">
            <h1 class="setup-title">Welcome to Cursor Playground</h1>
            <p class="setup-subtitle">Create your profile to join the experience</p>
        </div>

        <div class="setup-form">
            <!-- Name Input -->
            <div class="form-group">
                <label for="username">
                    <span class="label-icon">@selectedEmoji</span>
                    Your Name
                </label>
                <input
                    id="username"
                    type="text"
                    @bind="userName"
                    @bind:event="oninput"
                    placeholder="Enter your name..."
                    maxlength="20"
                    class="form-input" />
                <div class="input-hint">@userName.Length/20 characters</div>
            </div>

            <!-- Emoji Selection -->
            <div class="form-group">
                <label>
                    <span class="label-icon">*</span>
                    Choose Your Avatar
                </label>
                <div class="emoji-grid">
                    @foreach (var emoji in AvailableEmojis)
                    {
                        <button
                            class="emoji-button @(selectedEmoji == emoji ? "selected" : "")"
                            @onclick="() => SelectEmoji(emoji)"
                            title="Select @emoji">
                            @emoji
                        </button>
                    }
                </div>
            </div>

            <!-- Color Selection -->
            <div class="form-group">
                <label>
                    <span class="label-icon" style="color: @selectedColor">‚óè</span>
                    Choose Your Color
                </label>
                <div class="color-grid">
                    @foreach (var color in AvailableColors)
                    {
                        <button
                            class="color-button @(selectedColor == color.Value ? "selected" : "")"
                            style="--color-value: @color.Value"
                            @onclick="() => SelectColor(color.Value)"
                            title="@color.Name">
                            @if (selectedColor == color.Value)
                            {
                                <span class="checkmark">‚úì</span>
                            }
                        </button>
                    }
                </div>
            </div>

            <!-- Live Preview -->
            <div class="preview-section">
                <div class="preview-label">Live Preview</div>
                <div class="preview-card">
                    <div class="preview-cursor" style="--cursor-color: @selectedColor">
                        <span class="preview-emoji">@selectedEmoji</span>
                    </div>
                    <div class="preview-info">
                        <span class="preview-name" style="color: @selectedColor">
                            @(string.IsNullOrWhiteSpace(userName) ? "Your Name" : userName)
                        </span>
                        <span class="preview-status">Ready to play</span>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button
                class="submit-button @(isJoining ? "loading" : "")"
                @onclick="JoinPlayground"
                disabled="@(!IsValid || isJoining)">
                @if (isJoining)
                {
                    <span class="button-spinner"></span>
                    <span>Joining...</span>
                }
                else
                {
                    <span>Enter Playground</span>
                    <span class="button-arrow">‚Üí</span>
                }
            </button>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    <span class="error-icon">!</span>
                    @errorMessage
                </div>
            }
        </div>

        <div class="setup-footer">
            <span>Real-time cursor tracking powered by Convex</span>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<(string UserId, string Name, string Emoji, string Color)> OnJoined { get; set; }
    [Parameter] public bool IsVisible { get; set; } = true;

    private string userName = "";
    private string selectedEmoji = "üòä";
    private string selectedColor = "#64C8FF";
    private bool isJoining = false;
    private string errorMessage = "";

    private readonly string[] AvailableEmojis = new[]
    {
        "üòä", "üòé", "ü§ñ", "üëΩ", "ü¶Ñ", "üê±", "üê∂", "üêº",
        "ü¶ä", "üê∏", "ü¶Å", "üêØ", "üê®", "üêÆ", "üê∑", "üêµ",
        "üåü", "‚≠ê", "‚ú®", "üí´", "üî•", "üíé", "üëë", "üé®"
    };

    private readonly (string Name, string Value)[] AvailableColors = new[]
    {
        ("Blue", "#64C8FF"),
        ("Purple", "#B794F6"),
        ("Pink", "#F687B3"),
        ("Red", "#FC8181"),
        ("Orange", "#F6AD55"),
        ("Yellow", "#F6E05E"),
        ("Green", "#68D391"),
        ("Teal", "#4FD1C5"),
        ("Cyan", "#63B3ED"),
        ("Indigo", "#7C3AED")
    };

    private bool IsValid => !string.IsNullOrWhiteSpace(userName) && userName.Length >= 2;

    private void SelectEmoji(string emoji)
    {
        selectedEmoji = emoji;
        errorMessage = "";
    }

    private void SelectColor(string color)
    {
        selectedColor = color;
        errorMessage = "";
    }

    private async Task JoinPlayground()
    {
        if (!IsValid) return;

        try
        {
            isJoining = true;
            errorMessage = "";

            // Join the playground
            var userId = await CursorService.JoinAsync(userName.Trim(), selectedEmoji, selectedColor);

            // Notify parent component
            await OnJoined.InvokeAsync((userId, userName.Trim(), selectedEmoji, selectedColor));
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to join: {ex.Message}";
            Console.WriteLine($"Join error: {ex}");
        }
        finally
        {
            isJoining = false;
        }
    }
}
