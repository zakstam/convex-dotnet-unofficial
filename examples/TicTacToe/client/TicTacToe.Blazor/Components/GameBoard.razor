@* Game Board Component - Shows the active game and board *@
@using Convex.Generated

<div class="game-board-container">
    <div class="game-info-panel">
        <div class="players">
            <div class="player @(Game.PlayerX == Username ? "current-user" : "")">
                <span class="symbol">‚ùå</span>
                <span class="name">@Game.PlayerX</span>
                @if (Game.CurrentTurn == GameCurrentTurn.X && Game.Status == GameStatus.Playing)
                {
                    <span class="turn-indicator">‚Üê Your turn</span>
                }
            </div>
            <div class="vs">VS</div>
            <div class="player @(Game.PlayerO == Username ? "current-user" : "")">
                <span class="symbol">‚≠ï</span>
                <span class="name">@(Game.PlayerO ?? "Waiting...")</span>
                @if (Game.CurrentTurn == GameCurrentTurn.O && Game.Status == GameStatus.Playing)
                {
                    <span class="turn-indicator">‚Üê Your turn</span>
                }
            </div>
        </div>

        @if (Game.Status == GameStatus.Waiting)
        {
            <div class="game-status waiting">
                <p>‚è≥ Waiting for opponent to join...</p>
            </div>
        }
        else if (Game.Status == GameStatus.Finished)
        {
            <div class="game-status finished">
                @if (Game.Winner == GameWinner.Draw)
                {
                    <p class="result">ü§ù It's a draw!</p>
                }
                else if (Game.Winner == GameWinner.X)
                {
                    <p class="result">@(Game.PlayerX == Username ? "üéâ You won!" : $"‚ùå {Game.PlayerX} wins!")</p>
                }
                else if (Game.Winner == GameWinner.O)
                {
                    <p class="result">@(Game.PlayerO == Username ? "üéâ You won!" : $"‚≠ï {Game.PlayerO} wins!")</p>
                }
            </div>
        }
    </div>

    <!-- Tic-Tac-Toe Board -->
    <div class="board">
        @for (int i = 0; i < 9; i++)
        {
            int position = i;
            <GameCell Position="@position"
                     Value="@Game.Board[position]"
                     IsDisabled="@IsPositionDisabled(position)"
                     OnCellClick="() => OnMakeMove.InvokeAsync(position)" />
        }
    </div>

    <!-- Game Controls -->
    <div class="game-controls">
        @if (Game.Status == GameStatus.Finished)
        {
            <button @onclick="() => OnNewGame.InvokeAsync()"
                    class="btn-primary">
                New Game
            </button>
        }
        else if (Game.Status == GameStatus.Playing)
        {
            <button @onclick="() => OnForfeit.InvokeAsync()"
                    class="btn-danger">
                Forfeit Game
            </button>
        }
        <button @onclick="() => OnNewGame.InvokeAsync()"
                class="btn-secondary">
            Back to Lobby
        </button>
    </div>
</div>

@code {
    [Parameter]
    public Game Game { get; set; } = new();

    [Parameter]
    public string Username { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<int> OnMakeMove { get; set; }

    [Parameter]
    public EventCallback OnForfeit { get; set; }

    [Parameter]
    public EventCallback OnNewGame { get; set; }

    private bool IsPositionDisabled(int position)
    {
        // Disable if game not playing
        if (Game.Status != GameStatus.Playing)
            return true;

        // Disable if position already taken
        if (!string.IsNullOrEmpty(Game.Board[position]))
            return true;

        // Disable if not current player's turn
        var isPlayerX = Game.PlayerX == Username;
        var isPlayerO = Game.PlayerO == Username;

        if (isPlayerX && Game.CurrentTurn != GameCurrentTurn.X)
            return true;
        if (isPlayerO && Game.CurrentTurn != GameCurrentTurn.O)
            return true;

        // If not a player in this game, disable
        if (!isPlayerX && !isPlayerO)
            return true;

        return false;
    }
}
